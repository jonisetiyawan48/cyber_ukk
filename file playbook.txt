---
- name: Install LAMP stack and configure MySQL
  hosts: webservers
  become: yes
  vars:
    mysql_root_password: "19091996Jss"
    mysql_user: "cyber"
    mysql_user_password: "pass2023"
    db_name: "cyber23"
    git_repo: "https://github.com/jonisetiyawan48/cyber_ukk.git"
    web_root: "/var/www/html"

  tasks:
    - name: Install Apache, MariaDB, and PHP
      apt:
        name:
          - apache2
          - mariadb-server
          - php
          - php-mysqli
          - php-mbstring
        state: present
        update_cache: yes

    - name: Install Python MySQL library
      apt:
        name: python3-pymysql
        state: present

    - name: Start and enable Apache
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Start and enable MariaDB
      service:
        name: mariadb
        state: started
        enabled: yes

    - name: Wait for MariaDB to start
      wait_for:
        port: 3306
        state: started
        timeout: 30

#    - name: Set MariaDB root password
#      mysql_user:
#        name: root
#        host: localhost
#        password: "{{ mysql_root_password }}"
#        state: present

    - name: Create .my.cnf file for root
      copy:
        dest: /root/.my.cnf
        content: |
          [client]
          user=root
          password={{ mysql_root_password }}
        mode: '0600'

    - name: Create MySQL database and user
      mysql_db:
        name: "{{ db_name }}"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Create MySQL user
      mysql_user:
        name: "{{ mysql_user }}"
        password: "{{ mysql_user_password }}"
        host: localhost
        priv: "*.*:ALL"
        state: present
        login_user: root
        login_password: "{{ mysql_root_password }}"

    - name: Check if web root directory exists
      stat:
        path: "{{ web_root }}"
      register: web_root_stat

    - name: Ensure web root directory is empty
      command: rm -rf {{ web_root }}/*
      when: web_root_stat.stat.exists and web_root_stat.stat.isdir

    - name: Clone Git repository if not present
      git:
        repo: "{{ git_repo }}"
        dest: "{{ web_root }}/"
        update: yes

    - name: Import SQL file into database
      mysql_db:
        name: "{{ db_name }}"
        state: import
        target: "{{ web_root }}/db.sql"
